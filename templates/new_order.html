{% extends "base.html" %}
{% block title %}New Order{% endblock %}
{% block content %}
<h1 class="mb-4">新規注文</h1>

<div class="row">
  <!-- 左カラム：注文フォーム -->
  <div class="col-md-5">
    <form method="post" id="orderForm" class="card shadow-sm p-4">
      {{ form.hidden_tag() }}

      <div class="mb-3">
        {{ form.customer_name.label(class="form-label") }}
        {{ form.customer_name(class="form-control") }}
      </div>

      <div class="mb-3">
        {{ form.product_id.label(class="form-label") }}
        {{ form.product_id(class="form-select", id="productSelect") }}
      </div>

      <div class="mb-3">
        {{ form.quantity.label(class="form-label") }}
        {{ form.quantity(class="form-control", id="quantityInput") }}
        <div class="invalid-feedback">在庫数を超えています</div>
      </div>

      <div class="mb-3">
        {{ form.desired_date.label(class="form-label") }}
        {{ form.desired_date(class="form-control") }}
      </div>

      <div class="mb-3">
        {{ form.note.label(class="form-label") }}
        {{ form.note(class="form-control") }}
      </div>

      <div class="d-grid">
        {{ form.submit(class="btn btn-primary btn-lg", id="submitBtn") }}
      </div>
    </form>
  </div>

  <!-- 右カラム：在庫状況 -->
  <div class="col-md-7">
    <h4>在庫状況</h4>
    <div class="table-responsive">
      <table class="table table-hover table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>商品</th>
            <th>価格</th>
            <th>在庫</th>
          </tr>
        </thead>
        <tbody>
          {% for p in products %}
          <tr>
            <td>
              {% if p.image_url %}
                <img src="{{ url_for('static', filename=p.image_url) }}"
                     alt="{{ p.name }}"
                     style="width:50px; height:50px; object-fit:cover; margin-right:8px;">
              {% endif %}
              {{ p.name }}
            </td>
            <td>{{ p.price }}</td>
            <td>
              {% if p.stock and p.stock.quantity <= 3 %}
                <span class="badge bg-danger">残り {{ p.stock.quantity }}</span>
              {% elif p.stock %}
                {{ p.stock.quantity }}
              {% else %}
                <span class="badge bg-secondary">N/A</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- 在庫チェック用スクリプト~~がひかれてるけど問題なし -->
<script>
  const stockData = {
    {% for p in products %}
      "{{ p.id }}": {{ p.stock.quantity if p.stock else 0 }},
    {% endfor %}
  };

  const productSelect = document.getElementById("productSelect");
  const quantityInput = document.getElementById("quantityInput");
  const submitBtn = document.getElementById("submitBtn");

  function validateStock() {
    const productId = productSelect.value;
    const qty = parseInt(quantityInput.value) || 0;
    const stock = stockData[productId] || 0;

    if (qty > stock) {
      submitBtn.disabled = true;
      quantityInput.classList.add("is-invalid");
    } else {
      submitBtn.disabled = false;
      quantityInput.classList.remove("is-invalid");
    }
  }

  productSelect.addEventListener("change", validateStock);
  quantityInput.addEventListener("input", validateStock);

  // 初期チェック
  validateStock();
</script>
{% endblock %}
